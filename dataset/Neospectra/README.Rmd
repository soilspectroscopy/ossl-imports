---
title: "Dataset import: Neospectra"
author: "Jose Lucas Safanelli (jsafanelli@woodwellclimate.org), Colleen Smith (csmith@woodwellclimate.org), Jonathan Sanderman (jsanderman@woodwellclimate.org) - "
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  github_document:
    toc: true
    toc_depth: 4
bibliography: ../../tex/refs.bib
csl: ../../tex/apa.csl  
fig_caption: yes
link-citations: yes
twitter-handle: soilspec
header-includes:
- \usepackage{caption}
editor_options: 
  markdown: 
    wrap: 72
---

[<img src="../../img/soilspec4gg-logo_fc.png" alt="SoilSpec4GG logo" width="250"/>](https://soilspectroscopy.org/)

[<img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" />](http://creativecommons.org/licenses/by-sa/4.0/)

This work is licensed under a [Creative Commons Attribution-ShareAlike 4.0 International License](http://creativecommons.org/licenses/by-sa/4.0/).

```{r setup, include=FALSE}
library(captioner)
fig_nums <- captioner(prefix = "Fig.")
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
options(scipen = 999)
```

## Neospectra database

Part of: <https://github.com/soilspectroscopy>  
Project: [Soil Spectroscopy for Global
Good](https://soilspectroscopy.org)  
Last update: `r Sys.Date()`  
Dataset: [Neospectra database](https://soilspectroscopy.github.io/ossl-manual/neospectra-database.html)

A NIR soil spectral library was compiled using the NeoSpectra Handheld NIR Analyzer developed by Si-Ware (@sanderman_jonathan_2023_7586622). This library includes 2,106 distinct mineral soil samples scanned across 9 of these portable low-cost NIR spectrometers (indicated by serial no). All samples were scanned on dry and 2mm sieved soil. Site, soil and MIR spectra were fetched from KSSL database.

The database is available in <https://doi.org/10.5281/zenodo.7586622>.

Input datasets:  
- `Neospectra_WoodwellKSSL_avg_soil+site+NIR.csv`.  
- `Neospectra_WoodwellKSSL_avg_MIR.csv`.  

```{r packages, include=TRUE, echo=FALSE, eval=TRUE}
packages <- c("tidyverse", "prospectr", "measurements", "readxl", "stringr",
              "olctools", "openssl", "tmap", "sf", "skimr", "lubridate", "countrycode",
              "googledrive", "googlesheets4", "data.table", "doMC", "tictoc", "qs")
new.packages <- packages[!(packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)
invisible(lapply(packages, library, character.only = TRUE))
source("../../R-code/functions/SSL_functions.R")
```

Directory/folder path
```{r}
dir = "/mnt/soilspec4gg/ossl/dataset/Neospectra/"
tic()
```

## Data import

### Soil site information

```{r}
# Reading files
neospectra <- read_csv(paste0(dir, "/Neospectra_WoodwellKSSL_avg_soil+site+NIR.csv"))

# # Checking names. Spectra starts at column 55
# names(neospectra[,1:56])
# View(neospectra[,1:56])

neospectra.sitedata <- neospectra %>%
  rename(id.layer_local_c = lay_id,
         id.sample_local_c = kssl_id,
         longitude.point_wgs84_dd = longitude.std.decimal.degrees,
         latitude.point_wgs84_dd = latitude.std.decimal.degrees,
         layer.upper.depth_usda_cm = lay.depth.to.top,
         layer.lower.depth_usda_cm = lay.depth.to.bottom,
         layer.texture_usda_txt = texture.description,
         pedon.taxa_usda_txt = taxonomic.classification.name,
         horizon.designation_usda_txt = horizon.designation,
         longitude.county_wgs84_dd = long.xcntr,
         latitude.county_wgs84_dd = lat.ycntr,
         observation.date.begin_iso.8601_yyyy.mm.dd = fiscal.year) %>%
  mutate(id.layer_local_c = as.character(id.layer_local_c),
         location.point.error_any_m = 30,
         observation.date.end_iso.8601_yyyy.mm.dd = observation.date.begin_iso.8601_yyyy.mm.dd,
         location.country_iso.3166_txt = countrycode::countrycode(country, origin = 'country.name', destination = 'iso3c')) %>%
  mutate(layer.sequence_usda_uint16 = NA,
         id.project_ascii_txt = "Neospectra database",
         observation.ogc.schema.title_ogc_txt = "Open Soil Spectroscopy Library",
         observation.ogc.schema_idn_url = "https://soilspectroscopy.github.io",
         surveyor.title_utf8_txt = "USDA NRCS staff",
         surveyor.contact_ietf_email = "rich.ferguson@usda.gov",
         surveyor.address_utf8_txt = "USDA-NRCS-NSSC, Federal Building, Room 152, Mail Stop, 100 Centennial Mall North, Lincoln, NE",
         dataset.title_utf8_txt = "Neospectra NIR soil spectral library",
         dataset.owner_utf8_txt = "USDA-NRCS-NSSC-KSSL; WCRC; UNL; iSDA",
         dataset.code_ascii_txt = "NEOSPECTRA.SSL",
         dataset.address_idn_url = "https://doi.org/10.5281/zenodo.7586622",
         dataset.doi_idf_url = "https://doi.org/10.5281/zenodo.7586622",
         dataset.license.title_ascii_txt = "CC-BY",
         dataset.license.address_idn_url = "https://creativecommons.org/licenses/by/4.0/",
         dataset.contact.name_utf8_txt = "Jonathan Sanderman",
         dataset.contact_ietf_email = "jsanderman@woodwellclimate.org") %>%
  mutate(id.location_olc_txt = olctools::encode_olc(latitude.point_wgs84_dd, longitude.point_wgs84_dd, 10),
         .after = id.project_ascii_txt) %>%
  select(id.sample_local_c,
         id.layer_local_c,
         longitude.point_wgs84_dd,
         latitude.point_wgs84_dd,
         location.point.error_any_m,
         layer.upper.depth_usda_cm,
         layer.lower.depth_usda_cm,
         layer.sequence_usda_uint16,
         id.project_ascii_txt,
         id.location_olc_txt,
         location.country_iso.3166_txt,
         layer.texture_usda_txt,
         pedon.taxa_usda_txt,
         horizon.designation_usda_txt,
         observation.date.begin_iso.8601_yyyy.mm.dd,
         observation.date.end_iso.8601_yyyy.mm.dd,
         longitude.county_wgs84_dd,
         latitude.county_wgs84_dd,
         observation.ogc.schema.title_ogc_txt,
         observation.ogc.schema_idn_url,
         dataset.code_ascii_txt,
         dataset.title_utf8_txt,
         dataset.owner_utf8_txt,
         dataset.address_idn_url,
         dataset.doi_idf_url,
         surveyor.title_utf8_txt,
         surveyor.contact_ietf_email,
         surveyor.address_utf8_txt,
         dataset.license.title_ascii_txt,
         dataset.license.address_idn_url,
         dataset.contact.name_utf8_txt,
         dataset.contact_ietf_email) %>%
  mutate_at(vars(starts_with("id.")), as.character) %>%
  group_by(id.sample_local_c) %>%
  summarise_all(first)

# Saving version to dataset root dir
site.qs = paste0(dir, "ossl/neospectra_soilsite_v1.2.qs")
qs::qsave(neospectra.sitedata, site.qs, preset = "high")
```

### Soil lab information

NOTE: The code chunk below this paragraph is hidden. Just run once for getting the original names of soil properties, descriptions, data types, and units. Run once and upload to Google Sheet for formatting and integrating with the OSSL. Requires Google authentication.

<!-- ```{r, eval=FALSE, echo=TRUE} -->
<!-- # Reading files -->
<!-- neospectra <- read_csv(paste0(dir, "/Neospectra_WoodwellKSSL_avg_soil+site+NIR.csv")) -->

<!-- # # Checking names. Spectra starts at column 55 -->
<!-- # names(neospectra[,1:56]) -->
<!-- # View(neospectra[,1:56]) -->

<!-- # Getting soillab original variables -->
<!-- soillab.names <- neospectra %>% -->
<!--   select(1:2, 33:55) %>% -->
<!--   names(.) %>% -->
<!--   tibble(original_name = .) %>% -->
<!--   dplyr::mutate(table = '_avg_soil+site+NIR', .before = 1) %>% -->
<!--   dplyr::mutate(import = '', -->
<!--                 ossl_abbrev = '', -->
<!--                 ossl_method = '', -->
<!--                 ossl_unit = '', -->
<!--                 ossl_convert = '', -->
<!--                 ossl_name = '', -->
<!--                 .after = original_name) %>% -->
<!--   dplyr::mutate(comment = '') -->

<!-- readr::write_csv(soillab.names, paste0(getwd(), "/neospectra_soillab_names.csv")) -->

<!-- # Uploading to google sheet -->

<!-- # FACT CIN folder. Get ID for soildata importing table -->
<!-- googledrive::drive_ls(as_id("0AHDIWmLAj40_Uk9PVA")) -->

<!-- OSSL.soildata.importing <- "19LeILz9AEnKVK7GK0ZbK3CCr2RfeP-gSWn5VpY8ETVM" -->

<!-- # Checking metadata -->
<!-- googlesheets4::as_sheets_id(OSSL.soildata.importing) -->

<!-- # Checking readme -->
<!-- googlesheets4::read_sheet(OSSL.soildata.importing, sheet = 'readme') -->

<!-- # Preparing soillab.names -->
<!-- upload <- dplyr::as_tibble(soillab.names) -->

<!-- # Uploading -->
<!-- googlesheets4::write_sheet(upload, ss = OSSL.soildata.importing, sheet = "Neospectra") -->

<!-- # Checking metadata -->
<!-- googlesheets4::as_sheets_id(OSSL.soildata.importing) -->
<!-- ``` -->

NOTE: The code chunk below this paragraph is hidden. Run once for importing the transformation rules. The table can be edited online at Google Sheets. A copy is downloaded to github for archiving.

<!-- ```{r soilab_download, include=FALSE, echo=FALSE, eval=FALSE} -->
<!-- # Downloading from google sheet -->

<!-- # FACT CIN folder id -->
<!-- listed.table <- googledrive::drive_ls(as_id("0AHDIWmLAj40_Uk9PVA"), -->
<!--                                       pattern = "OSSL_tab2_soildata_importing") -->

<!-- OSSL.soildata.importing <- listed.table[[1,"id"]] -->

<!-- # Checking metadata -->
<!-- googlesheets4::as_sheets_id(OSSL.soildata.importing) -->

<!-- # Preparing soillab.names -->
<!-- transvalues <- googlesheets4::read_sheet(OSSL.soildata.importing, sheet = "Neospectra") %>% -->
<!--   filter(import == TRUE) %>% -->
<!--   select(contains(c("table", "id", "original_name", "ossl_", "comment"))) -->

<!-- # Saving to folder -->
<!-- write_csv(transvalues, paste0(getwd(), "/OSSL_transvalues.csv")) -->
<!-- ``` -->

Reading AFSIS1-to-OSSL transformation values:
```{r soilab_transvalues, include=TRUE, echo=TRUE, eval=TRUE}
transvalues <- read_csv(paste0(getwd(), "/OSSL_transvalues.csv")) %>%
  select(-comment)
knitr::kable(transvalues)
```

Preparing soil data:
```{r soilab_preparation, include=TRUE, echo=TRUE, eval=TRUE}
neospectra <- read_csv(paste0(dir, "/Neospectra_WoodwellKSSL_avg_soil+site+NIR.csv"))

# Harmonization of names and units
analytes.old.names <- transvalues %>%
  pull(original_name)

analytes.new.names <- transvalues %>%
  pull(ossl_name)

# Selecting and renaming
neospectra.soildata <- neospectra %>%
  rename(id.sample_local_c = kssl_id) %>%
  select(id.sample_local_c, all_of(analytes.old.names)) %>%
  group_by(id.sample_local_c) %>%
  summarise_all(first) %>%
  rename_with(~analytes.new.names, analytes.old.names) %>%
  mutate(id.sample_local_c = as.character(id.sample_local_c)) %>%
  as.data.frame()

# Removing duplicates
neospectra.soildata %>%
  group_by(id.sample_local_c) %>%
  summarise(repeats = n()) %>%
  group_by(repeats) %>%
  summarise(count = n())

# Getting the formulas
functions.list <- transvalues %>%
  mutate(ossl_name = factor(ossl_name, levels = names(neospectra.soildata))) %>%
  arrange(ossl_name) %>%
  pull(ossl_convert) %>%
  c("x", .)

# Applying transformation rules
neospectra.soildata.trans <- transform_values(df = neospectra.soildata,
                                              out.name = names(neospectra.soildata),
                                              in.name = names(neospectra.soildata),
                                              fun.lst = functions.list)

# Final soillab data
neospectra.soildata <- neospectra.soildata.trans %>%
  mutate_at(vars(starts_with("id.")), as.character)

# Checking total number of observations
neospectra.soildata %>%
  distinct(id.sample_local_c) %>%
  summarise(count = n())

# Saving version to dataset root dir
soillab.qs = paste0(dir, "ossl/neospectra_soillab_v1.2.qs")
qs::qsave(neospectra.soildata, soillab.qs, preset = "high")
```

### Near-infrared spectroscopy data

```{r nir, include=TRUE, echo=TRUE, eval=TRUE}
# Floating wavelength
neospectra <- read_csv(paste0(dir, "/Neospectra_WoodwellKSSL_avg_soil+site+NIR.csv"))
# names(neospectra[,1:56])

# Resampling to 2 nm interval
# Formatting as fraction percent with 5 digits of precision
old.spectra.columns <- neospectra %>%
  select(56:ncol(neospectra)) %>%
  names()

neospectra.nir <- neospectra %>%
  rename(id.scan_local_c = Lab_ID) %>%
  select(id.scan_local_c, all_of(old.spectra.columns))

new.spectra.columns <- seq(2550, 1350, by = -2)

neospectra.nir.2nm <- neospectra.nir %>%
  select(all_of(old.spectra.columns)) %>%
  as.matrix() %>%
  prospectr::resample(X = ., wav = as.numeric(old.spectra.columns), new.wav = new.spectra.columns, interpol = "spline") %>%
  as_tibble() %>%
  bind_cols({neospectra.nir %>%
      select(id.scan_local_c)}, .) %>%
  select(id.scan_local_c, all_of(rev(as.character(new.spectra.columns)))) %>%
  mutate_if(is.numeric, function(x){round(x/100, 5)})

# Gaps
scans.na.gaps <- neospectra.nir.2nm %>%
  select(-id.scan_local_c) %>%
  apply(., 1, function(x) round(100*(sum(is.na(x)))/(length(x)), 2)) %>%
  tibble(proportion_NA = .) %>%
  bind_cols({neospectra.nir.2nm %>% select(id.scan_local_c)}, .)

# Extreme negative - irreversible erratic patterns
scans.extreme.neg <- neospectra.nir.2nm %>%
  select(-id.scan_local_c) %>%
  apply(., 1, function(x) {round(100*(sum(x < 0, na.rm=TRUE))/(length(x)), 2)}) %>%
  tibble(proportion_lower0 = .) %>%
  bind_cols({neospectra.nir.2nm %>% select(id.scan_local_c)}, .)

# Extreme positive, irreversible erratic patterns
scans.extreme.pos <- neospectra.nir.2nm %>%
  select(-id.scan_local_c) %>%
  apply(., 1, function(x) {round(100*(sum(x > 1, na.rm=TRUE))/(length(x)), 2)}) %>%
  tibble(proportion_higherRef1 = .) %>%
  bind_cols({neospectra.nir.2nm %>% select(id.scan_local_c)}, .)

# Consistency summary - problematic scans
scans.summary <- scans.na.gaps %>%
  left_join(scans.extreme.neg, by = "id.scan_local_c") %>%
  left_join(scans.extreme.pos, by = "id.scan_local_c")

scans.summary %>%
  select(-id.scan_local_c) %>%
  pivot_longer(everything(), names_to = "check", values_to = "value") %>%
  filter(value > 0) %>%
  group_by(check) %>%
  summarise(count = n())

# Renaming
old.wavenumbers <- seq(1350, 2250, by = 2)
new.wavenumbers <- paste0("scan_nir.", old.wavenumbers, "_ref")

neospectra.nir.2nm <- neospectra.nir.2nm %>%
  rename_with(~new.wavenumbers, as.character(old.wavenumbers))

# Metadata
neospectra.nir.metadata <- neospectra %>%
  rename(id.sample_local_c = kssl_id,
         id.scan_local_c = Lab_ID,
         scan.lab_utf8_txt = Lab,
         scan.nir.model.name_utf8_txt = scanner_name,
         scan.nir.model.serialnumber_utf8_int = scanner_SerialNo,
         scan.nir.accessory.used_utf8_txt = saucer) %>%
  mutate(scan.nir.date.begin_iso.8601_yyyy.mm.dd = "2021-01-01",
         scan.nir.date.end_iso.8601_yyyy.mm.dd = "2022-12-31",
         scan.nir.method.preparation_any_txt = "<2 mm",
         scan.nir.license.title_ascii_txt = "CC-BY",
         scan.nir.license.address_idn_url = "https://creativecommons.org/licenses/by/4.0/",
         scan.nir.doi_idf_url = "https://doi.org/10.5281/zenodo.7586622",
         scan.nir.contact.name_utf8_txt = "Jonathan Sanderman",
         scan.nir.contact.email_ietf_txt = "jsanderman@woodwellclimate.org") %>%
  select(id.sample_local_c, id.scan_local_c, scan.lab_utf8_txt,
         scan.nir.date.begin_iso.8601_yyyy.mm.dd, scan.nir.date.end_iso.8601_yyyy.mm.dd,
         scan.nir.model.name_utf8_txt, scan.nir.model.serialnumber_utf8_int,
         scan.nir.accessory.used_utf8_txt, scan.nir.method.preparation_any_txt,
         scan.nir.license.title_ascii_txt, scan.nir.license.address_idn_url,
         scan.nir.doi_idf_url, scan.nir.contact.name_utf8_txt, scan.nir.contact.email_ietf_txt)

# Final preparation
neospectra.nir.export <- neospectra.nir.metadata %>%
  left_join(neospectra.nir.2nm, by = "id.scan_local_c") %>%
  mutate_at(vars(starts_with("id.")), as.character)

# Saving version to dataset root dir
nir.qs = paste0(dir, "ossl/neospectra_nir_v1.2.qs")
qs::qsave(neospectra.nir.export, nir.qs, preset = "high")
```

### Mid-infrared spectroscopy data

The MIR spectra available on Zenodo is already formatted to OSSL specifications. It was fetched from the OSSL database rather than the original KSSL database.

```{r mir, include=TRUE, echo=TRUE, eval=TRUE}
# Floating wavenumbers
neospectra.mir <- read_csv(paste0(dir, "/Neospectra_WoodwellKSSL_avg_MIR.csv"))

neospectra.mir <- neospectra.mir %>%
  rename(id.sample_local_c = kssl_id)

# Gaps
scans.na.gaps <- neospectra.mir %>%
  select(-id.sample_local_c) %>%
  apply(., 1, function(x) round(100*(sum(is.na(x)))/(length(x)), 2)) %>%
  tibble(proportion_NA = .) %>%
  bind_cols({neospectra.mir %>% select(id.sample_local_c)}, .)

# Extreme negative - irreversible erratic patterns
scans.extreme.neg <- neospectra.mir %>%
  select(-id.sample_local_c) %>%
  apply(., 1, function(x) {round(100*(sum(x < -1, na.rm=TRUE))/(length(x)), 2)}) %>%
  tibble(proportion_lower0 = .) %>%
  bind_cols({neospectra.mir %>% select(id.sample_local_c)}, .)

# Extreme positive, irreversible erratic patterns
scans.extreme.pos <- neospectra.mir %>%
  select(-id.sample_local_c) %>%
  apply(., 1, function(x) {round(100*(sum(x > 5, na.rm=TRUE))/(length(x)), 2)}) %>%
  tibble(proportion_higherAbs5 = .) %>%
  bind_cols({neospectra.mir %>% select(id.sample_local_c)}, .)

# Consistency summary - problematic scans
scans.summary <- scans.na.gaps %>%
  left_join(scans.extreme.neg, by = "id.sample_local_c") %>%
  left_join(scans.extreme.pos, by = "id.sample_local_c")

scans.summary %>%
  select(-id.sample_local_c) %>%
  pivot_longer(everything(), names_to = "check", values_to = "value") %>%
  filter(value > 0) %>%
  group_by(check) %>%
  summarise(count = n())

# Renaming
old.wavenumbers <- seq(600, 4000, by = 2)
new.wavenumbers <- paste0("scan_mir.", old.wavenumbers, "_abs")

neospectra.mir <- neospectra.mir %>%
  rename_with(~new.wavenumbers, as.character(old.wavenumbers))

# Preparing metadata
neospectra.mir.metadata <- neospectra.mir %>%
  select(id.sample_local_c) %>%
  mutate(scan.mir.date.begin_iso.8601_yyyy.mm.dd = ymd("2022-01-01"),
         scan.mir.date.end_iso.8601_yyyy.mm.dd = ymd("2022-12-31"),
         scan.mir.model.name_utf8_txt = "Bruker Vertex 70 with HTS-XT accessory",
         scan.mir.method.optics_any_txt = "KSSL SOPs",
         scan.mir.method.preparation_any_txt = "Finely ground <80 mesh",
         scan.mir.license.title_ascii_txt = "CC-BY",
         scan.mir.license.address_idn_url = "https://creativecommons.org/licenses/by/4.0/",
         scan.mir.doi_idf_url = "https://doi.org/10.5281/zenodo.4351254",
         scan.mir.contact.name_utf8_txt = "Laura Summerauer",
         scan.mir.contact.email_ietf_txt = "laura.summerauer@usys.ethz.ch")

# Final preparation
neospectra.mir.export <- neospectra.mir.metadata %>%
  left_join(neospectra.mir, by = "id.sample_local_c") %>%
  mutate_at(vars(starts_with("id.")), as.character)

# Saving version to dataset root dir
mir.qs = paste0(dir, "ossl/neospectra_mir_v1.2.qs")
qs::qsave(neospectra.mir.export, mir.qs, preset = "high")
```

### Quality control

The final table must be joined as:

- For NIR, left_join site and soil to NIR using "id.scan_local_c".
- For MIR, left_join site and soil to MIR using "id.sample_local_c".

The availabilty of data is summarised below:
```{r bind_test, include=TRUE, echo=TRUE, eval=TRUE}
# Taking a few representative columns for checking the consistency of joins
neospectra.availability <- neospectra.nir.export %>%
  select(id.scan_local_c, id.sample_local_c, scan_nir.2000_ref) %>%
  left_join({neospectra.mir.export %>%
      select(id.sample_local_c, scan_mir.1000_abs)}, by = "id.sample_local_c") %>%
  left_join({neospectra.sitedata %>%
      select(id.sample_local_c, layer.upper.depth_usda_cm)}, by = "id.sample_local_c") %>%
  left_join({neospectra.soildata %>%
      select(id.sample_local_c, ph.h2o_usda.a268_index)}, by = "id.sample_local_c")

# Availability of information from neospectra
neospectra.availability %>%
  mutate_all(as.character) %>%
  pivot_longer(everything(), names_to = "column", values_to = "value") %>%
  filter(!is.na(value)) %>%
  group_by(column) %>%
  summarise(count = n())

# Repeats check - scans may have same id but different metadata (scanning device, accessory, etc)
neospectra.availability %>%
  mutate_all(as.character) %>%
  select(id.scan_local_c) %>%
  pivot_longer(everything(), names_to = "column", values_to = "value") %>%
  group_by(column, value) %>%
  summarise(repeats = n()) %>%
  group_by(column, repeats) %>%
  summarise(count = n())
```

Plotting sites map:
```{r map, include=TRUE, echo=TRUE, eval=TRUE}
data("World")

points <- neospectra.sitedata %>%
  filter(!is.na(longitude.point_wgs84_dd)) %>%
  st_as_sf(coords = c('longitude.point_wgs84_dd', 'latitude.point_wgs84_dd'), crs = 4326)

tmap_mode("plot")

tm_shape(World) +
  tm_polygons('#f0f0f0f0', border.alpha = 0.2) +
  tm_shape(points) +
  tm_dots()
```

Soil analytical data summary.
```{r summary, include=TRUE, echo=TRUE, eval=TRUE}
neospectra.soildata %>%
  mutate(id.sample_local_c = factor(id.sample_local_c)) %>%
  skimr::skim() %>%
  dplyr::select(-numeric.hist, -complete_rate)
```

NIR spectral visualization:
```{r nir_plot, include=TRUE, echo=TRUE, eval=TRUE}
set.seed(1993)
selected.ids <- sample(neospectra.nir.export$id.sample_local_c, 20)
neospectra.nir.export %>%
  filter(id.sample_local_c %in% selected.ids) %>%
  select(all_of(c("id.scan_local_c", "scan.nir.model.serialnumber_utf8_int")), starts_with("scan_nir.")) %>%
  tidyr::pivot_longer(-all_of(c("id.scan_local_c", "scan.nir.model.serialnumber_utf8_int")),
                      names_to = "wavelength", values_to = "reflectance") %>%
  dplyr::mutate(wavelength = gsub("scan_nir.|_ref", "", wavelength)) %>%
  dplyr::mutate(wavelength = as.numeric(wavelength)) %>%
  ggplot(aes(x = wavelength, y = reflectance, group = id.scan_local_c)) +
  geom_line(alpha = 0.5, size = 0.5) +
  scale_x_continuous(breaks = c(1350, 1500, 1750, 2000, 2250)) +
  labs(x = "Wavelength (nm)", y = "Reflectance", color = "") +
  theme_light()
```

MIR spectral visualization:
```{r mir_plot, include=TRUE, echo=TRUE, eval=TRUE}
set.seed(1993)
neospectra.mir %>%
  sample_n(100) %>%
  select(all_of(c("id.sample_local_c")), starts_with("scan_mir.")) %>%
  tidyr::pivot_longer(-all_of(c("id.sample_local_c")),
                      names_to = "wavenumber", values_to = "absorbance") %>%
  dplyr::mutate(wavenumber = gsub("scan_mir.|_abs", "", wavenumber)) %>%
  dplyr::mutate(wavenumber = as.numeric(wavenumber)) %>%
  ggplot(aes(x = wavenumber, y = absorbance, group = id.sample_local_c)) +
  geom_line(alpha = 0.1) +
  scale_x_continuous(breaks = c(600, 1200, 1800, 2400, 3000, 3600, 4000)) +
  labs(x = bquote("Wavenumber"~(cm^-1)), y = "Absorbance") +
  theme_light()
```

```{r}
toc()
rm(list = ls())
gc()
```

## References
